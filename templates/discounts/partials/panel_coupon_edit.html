{% load djicons i18n djicons djicons %}

<div x-data="{ confirmDelete: false }">

    <!-- Header -->
    <div class="side-sheet-header">
        <h3 class="sheet-title">{% trans "Edit Coupon" %}</h3>
        <button class="sheet-close" @click="closePanel()">
            {% icon "close-outline" %}
        </button>
    </div>

    <!-- Body -->
    <div class="side-sheet-content">
        <form id="edit-coupon-form"
              hx-post="{% url 'discounts:coupon_edit' coupon.id %}"
              hx-target="#datatable-body"
              hx-swap="innerHTML"
              @htmx:after-request="closePanel()"
              class="flex flex-col gap-4 p-6">
            {% csrf_token %}

            <!-- Code -->
            <div>
                <label class="text-sm font-medium mb-1 block">{% trans "Code" %} *</label>
                <input type="text" name="code" class="input input-sm w-full"
                       value="{{ coupon.code }}" style="text-transform: uppercase;" required>
            </div>

            <!-- Name -->
            <div>
                <label class="text-sm font-medium mb-1 block">{% trans "Name" %} *</label>
                <input type="text" name="name" class="input input-sm w-full"
                       value="{{ coupon.name }}" placeholder="{% trans 'Coupon name' %}" required>
            </div>

            <!-- Description -->
            <div>
                <label class="text-sm font-medium mb-1 block">{% trans "Description" %}</label>
                <textarea name="description" class="textarea textarea-sm w-full" rows="2"
                          placeholder="{% trans 'Coupon description...' %}">{{ coupon.description }}</textarea>
            </div>

            <!-- Discount Type -->
            <div>
                <label class="text-sm font-medium mb-1 block">{% trans "Discount Type" %} *</label>
                <select name="discount_type" class="select select-sm w-full" required>
                    <option value="percentage" {% if coupon.discount_type == 'percentage' %}selected{% endif %}>{% trans "Percentage" %}</option>
                    <option value="fixed" {% if coupon.discount_type == 'fixed' %}selected{% endif %}>{% trans "Fixed Amount" %}</option>
                    <option value="buy_x_get_y" {% if coupon.discount_type == 'buy_x_get_y' %}selected{% endif %}>{% trans "Buy X Get Y" %}</option>
                </select>
            </div>

            <!-- Discount Value -->
            <div>
                <label class="text-sm font-medium mb-1 block">{% trans "Discount Value" %} *</label>
                <input type="number" name="discount_value" class="input input-sm w-full"
                       min="0" step="0.01" value="{{ coupon.discount_value }}" required>
            </div>

            <!-- Scope -->
            <div>
                <label class="text-sm font-medium mb-1 block">{% trans "Scope" %}</label>
                <select name="scope" class="select select-sm w-full">
                    <option value="order" {% if coupon.scope == 'order' %}selected{% endif %}>{% trans "Entire Order" %}</option>
                    <option value="products" {% if coupon.scope == 'products' %}selected{% endif %}>{% trans "Specific Products" %}</option>
                    <option value="categories" {% if coupon.scope == 'categories' %}selected{% endif %}>{% trans "Specific Categories" %}</option>
                </select>
            </div>

            <!-- Min Purchase -->
            <div>
                <label class="text-sm font-medium mb-1 block">{% trans "Min. Purchase" %}</label>
                <input type="number" name="min_purchase" class="input input-sm w-full"
                       min="0" step="0.01" value="{{ coupon.min_purchase }}">
            </div>

            <!-- Max Discount -->
            <div>
                <label class="text-sm font-medium mb-1 block">{% trans "Max Discount" %}</label>
                <input type="number" name="max_discount" class="input input-sm w-full"
                       min="0" step="0.01" value="{{ coupon.max_discount }}">
                <span class="text-xs text-base-content/50 mt-1 block">{% trans "Leave empty for no limit" %}</span>
            </div>

            <!-- Usage Limit -->
            <div>
                <label class="text-sm font-medium mb-1 block">{% trans "Usage Limit" %}</label>
                <input type="number" name="usage_limit" class="input input-sm w-full"
                       min="0" value="{{ coupon.usage_limit }}">
                <span class="text-xs text-base-content/50 mt-1 block">{% trans "0 = unlimited" %}</span>
            </div>

            <!-- Usage Per Customer -->
            <div>
                <label class="text-sm font-medium mb-1 block">{% trans "Usage Per Customer" %}</label>
                <input type="number" name="usage_per_customer" class="input input-sm w-full"
                       min="1" value="{{ coupon.usage_per_customer }}">
            </div>

            <!-- Valid From -->
            <div>
                <label class="text-sm font-medium mb-1 block">{% trans "Valid From" %}</label>
                <input type="datetime-local" name="valid_from" class="input input-sm w-full"
                       value="{{ coupon.valid_from|date:'Y-m-d\TH:i' }}">
            </div>

            <!-- Valid Until -->
            <div>
                <label class="text-sm font-medium mb-1 block">{% trans "Valid Until" %}</label>
                <input type="datetime-local" name="valid_until" class="input input-sm w-full"
                       value="{{ coupon.valid_until|date:'Y-m-d\TH:i' }}">
            </div>

            <!-- Priority -->
            <div>
                <label class="text-sm font-medium mb-1 block">{% trans "Priority" %}</label>
                <input type="number" name="priority" class="input input-sm w-full"
                       min="0" value="{{ coupon.priority }}">
            </div>

            <!-- Stackable -->
            <div>
                <label class="checkbox checkbox-sm">
                    <input type="checkbox" name="stackable" {% if coupon.stackable %}checked{% endif %}>
                    <span class="checkbox-mark"></span>
                    <span class="ml-2 text-sm font-medium">{% trans "Stackable" %}</span>
                </label>
                <span class="text-xs text-base-content/50 mt-1 block">{% trans "Can be combined with other discounts" %}</span>
            </div>

            <!-- Active -->
            <div>
                <label class="checkbox checkbox-sm">
                    <input type="checkbox" name="is_active" {% if coupon.is_active %}checked{% endif %}>
                    <span class="checkbox-mark"></span>
                    <span class="ml-2 text-sm font-medium">{% trans "Active" %}</span>
                </label>
            </div>
        </form>

        <!-- Stats -->
        <div class="border-t border-base-300 pt-4 mt-4 px-6">
            <h4 class="font-semibold text-sm mb-2">{% trans "Usage Stats" %}</h4>
            <div class="flex gap-4 text-sm text-base-content/60">
                <div>
                    <span class="font-medium">{% trans "Uses:" %}</span>
                    {{ coupon.usage_count }}{% if coupon.usage_limit %}/{{ coupon.usage_limit }}{% endif %}
                </div>
                {% if total_savings %}
                <div>
                    <span class="font-medium">{% trans "Savings:" %}</span>
                    <span class="text-success">{{ total_savings|floatformat:2 }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Delete Section -->
        <div class="border-t border-base-300 pt-4 mt-4 px-6 pb-6">
            <h4 class="font-semibold text-sm mb-3 text-error">{% trans "Danger Zone" %}</h4>

            <template x-if="!confirmDelete">
                <button type="button" class="btn btn-sm btn-outline color-error w-full"
                        @click="confirmDelete = true">
                    {% icon "trash-outline" %}
                    {% trans "Delete Coupon" %}
                </button>
            </template>

            <template x-if="confirmDelete">
                <div>
                    <p class="text-error text-sm font-semibold mb-3">
                        {% trans "Are you sure? This action cannot be undone." %}
                    </p>
                    <div class="flex gap-2">
                        <button type="button" class="btn btn-sm btn-outline flex-1"
                                @click="confirmDelete = false">
                            {% trans "Cancel" %}
                        </button>
                        <button type="button" class="btn btn-sm color-error flex-1"
                                hx-post="{% url 'discounts:coupon_delete' coupon.id %}"
                                hx-target="#datatable-body"
                                hx-swap="innerHTML"
                                @click="closePanel()">
                            {% icon "trash-outline" %}
                            {% trans "Delete" %}
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Footer -->
    <div class="side-sheet-footer">
        <div class="flex justify-end gap-2">
            <button type="button" class="btn btn-ghost btn-sm" @click="closePanel()">
                {% trans "Cancel" %}
            </button>
            <button type="submit" form="edit-coupon-form" class="btn btn-sm color-primary">
                {% icon "checkmark-outline" %}
                {% trans "Save" %}
            </button>
        </div>
    </div>

</div>
